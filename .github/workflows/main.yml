name: CI Pipeline - Build and Test Container

# Triggers the workflow on push events to the 'main' branch
on:
  push:
    branches: [ main ]
  # Allows you to manually run the workflow from the Actions tab
  workflow_dispatch:

jobs:
  # Define a job called 'build-and-test'
  build-and-test:
    # Runs on a fresh Ubuntu environment provided by GitHub
    runs-on: ubuntu-latest

    steps:
    # STEP 1: Check out the code from the repository
    - name: Checkout code
      uses: actions/checkout@v4

    # STEP 3: Build the Docker image based on your Dockerfile
    - name: Build Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: false # Do not push the image yet, just build it
        tags: quote-api:latest

    # STEP 4: Run Pytest inside the newly built Docker container
    # This proves the container image is valid and production-ready
    - name: Run Pytest inside container
      run: |
        # Run a temporary container from the built image and execute 'pytest'
        docker run --rm quote-api:latest /bin/bash -c "pip install pytest && pytest"
        # The 'pip install pytest' is sometimes needed if pytest was not installed in the Dockerfile
        # which it currently is not, making this command necessary.
